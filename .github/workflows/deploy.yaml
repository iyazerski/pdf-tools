name: deploy

on:
  push:
    branches: ["release/**"]
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "deploy" to confirm deployment'
        required: true
        default: ""

concurrency:
  group: pdf-tools-deploy
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.confirm_deployment == 'deploy'
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ github.repository }}:${{ github.sha }}
      NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          if [ -n "${{ secrets.KUBE_CONFIG }}" ]; then
            echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          else
            echo "${{ secrets.KUBE_CONFIG_B64 }}" | base64 -d > ~/.kube/config
          fi
          chmod 600 ~/.kube/config

      - name: Default namespace
        run: |
          if [ -z "${NAMESPACE}" ]; then
            echo "NAMESPACE=default" >> "$GITHUB_ENV"
          fi

      - name: Ensure namespace exists
        run: |
          kubectl get namespace "${NAMESPACE}" >/dev/null 2>&1 || kubectl create namespace "${NAMESPACE}"

      - name: Create GHCR image pull secret (optional)
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          PACKAGES_PAT: ${{ secrets.PACKAGES_PAT }}
        run: |
          if [ -z "${PACKAGES_PAT}" ]; then
            echo "PACKAGES_PAT is not set; skipping ghcr-pull-secret creation."
            exit 0
          fi
          if [ -z "${GHCR_USERNAME}" ]; then
            GHCR_USERNAME="${{ github.repository_owner }}"
          fi
          kubectl -n "${NAMESPACE}" create secret docker-registry ghcr-pull-secret \
            --docker-server=ghcr.io \
            --docker-username="${GHCR_USERNAME}" \
            --docker-password="${PACKAGES_PAT}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply app secrets
        run: |
          kubectl -n "${NAMESPACE}" create secret generic pdf-tools-secrets \
            --from-literal=APP_USERNAME="${{ secrets.APP_USERNAME }}" \
            --from-literal=APP_PASSWORD="${{ secrets.APP_PASSWORD }}" \
            --from-literal=SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy manifests
        run: |
          sed -e "s|ghcr.io/OWNER/REPO:latest|${IMAGE}|g" k8s/deployment.yaml | kubectl -n "${NAMESPACE}" apply -f -
          kubectl -n "${NAMESPACE}" apply -f k8s/service.yaml
          kubectl -n "${NAMESPACE}" apply -f k8s/ingress.yaml

      - name: Wait rollout
        run: |
          kubectl -n "${NAMESPACE}" rollout status deployment/pdf-tools --timeout=180s
